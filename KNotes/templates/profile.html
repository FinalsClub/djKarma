{% extends "base.html" %}
{% load url from future %}

{% block title %}
  Your Personal Profile Page {{ user.username }}
{% endblock %}


{% block header %}
  <script type="text/javascript">
    //$('.carousel('pause').carousel()')
    //$(".collapse").collapse()
  </script>

  <script type="text/javascript">

  var current_karma = {{ user.get_profile.karma }};

  $(document).ready(function(){
    $('.dropdown-toggle').dropdown();

    $("div.file.row-fluid").hover(function () {
          $(this).children('.file-info-action').toggleClass("hide");
      });

    $("div.showmore").click(function () {
            $(this).nextAll('div.file').slideToggle('slow');
      });

    $('input:radio').screwDefaultButtons({
                 checked: "url(/static/img/check.jpg)",
                 unchecked: "",
                 width: 50,
                 height: 50
              });

    // Handle profile school submission
    $(".select").on("change",function(){
      request_data = { 'user': {{user.pk}} }
      //console.log($(this).val());
      //console.log($("#school-select option:selected").val());
      if($(this).hasClass("school")){
        val = $("#school-select option:selected").val();
        if(val != "..."){
          console.log("submit school");
          request_data['school'] = val;
          ajax(request_data, school_callback);
        }
      }else if($(this).hasClass("year")){
        val = $("#year-select option:selected").val();
        request_data['year'] = val;
        ajax(request_data, year_callback);
      }
      
    });

    function ajax(request_data, callback){
      $.ajax({
              url: "/editProfile",
              data: request_data,
              success: callback,
              dataType: "json"
          });
    }

    function year_callback(data){
      if(data.status === "success"){
        $("#year-karma").fadeOut('slow', function(){
          $("#year-select").slideUp('slow',function(){
            $("#year-label").html(data.year).fadeIn('slow');
            if(data.karma){
              console.log(data.karma);
              animate_karma(data.karma);
            }
          });
        });
      }
    }

    function school_callback(data){
      if(data.status === "success"){
        $("#school-karma").fadeOut('slow', function(){
          $("#school-select").slideUp('slow',function(){
            $("#school-label").html(data.school).fadeIn('slow');
            if(data.karma){
              console.log(data.karma);
              animate_karma(data.karma);
            }
          });
        });
      }
    }

    function animate_karma(delta_karma){
      current_karma += delta_karma
      end_karma = {{ next_level.karma }};
      new_progress = (current_karma + delta_karma) / (end_karma)*100;
      console.log(String(new_progress+'%'));
      $('#karma-progress').animate({
        width: String(new_progress+'%'),
      }, 5000);
      $('#karma-label').fadeOut('fast', function(){
        $('#karma-label').html(current_karma + delta_karma).fadeIn('fast');
      });
      
    }

    });
  </script>
  <script src="/static/js/jquery.screwdefaultbuttons.min.js"/static/></script>
  <script src="http://static.ak.fbcdn.net/connect.php/js/FB.Share" type="text/javascript"> </script>

{% endblock %}


{% block content %}


<div class="profile-page container">
  <div class="row">
    <div class="span3">
      <ul class="nav nav-list">
        <li class="active">
          <a href="/browse">
            <i class="icon-book"></i>
            Browse notes
          </a>
        </li>
        <li>
          <a href="#share" class="karma" data-toggle="modal">
            <i class="icon-user"></i>
            Share KarmaNotes
            <div class="share-karma">Earn <span class="karma">5 points</span> for every signup</div>
          </a>
        </li>
      </ul>

      <h3>Profile</h3>
      <ul class="thumbnails">
        <li class="span3">
          <div class="thumbnail">
            <img alt="" src="http://placehold.it/230x100">
            <div class="caption">
              <p>{{ user.username }} <a href="#">edit</a></p>
              <!-- progress bar -->
              <p>Karma Points</p>
              <div class="progress progress-karma">
                <div id="karma-progress" class="bar"
                     style="width: {{progress}}%;"></div>
              </div>
              <div class="karma-label">
                <div class="karma-label-left" id="karma-label">{{ user.get_profile.karma }}</div>
                <div class="karma-label-right">{{ next_level.title}} {% if next_level %} ({{ next_level.karma }}) {% endif %}</div>
                <div style="clear:both"></div>
              </div>

              <p>Karma Status: <div class="karma-status">{{ current_level.title }}</div></p>

              <p>School:</p><span style="display:none" id="school-label"></span>
              {% if user_profile.school %}
                {{ user_profile.school }}
              {% else %}
              <select style="padding-top:5px" id="school-select" class="span2 select school">
                <option>...</option>
                {% for school in available_schools %}
                <option value="{{school.1}}">{{school.0}}</option>
                {% endfor %}
              </select><span id="school-karma" class="karma-points">+5&nbsp;points</span>
              {% endif %}
              <p style="padding-top:5px">Year of Graduation:</p><span style="display:none" id="year-label"></span>
              {# TODO: make this display inline if filled out #}
              {% if user_profile.grad_year %}
                {{ user_profile.grad_year }}
              {% else %}
              <select id="year-select" class="span2 select year">
                <option>...</option>
                {% for year in available_years %}
                <option>{{year}}</option>
                {% endfor %}
              </select><span id="year-karma" class="karma-points">+5&nbsp;points</span>
              {% endif %}
            </div>
          </div>
        </li>
      </ul>
    </div> <!-- .span3 -->

    <div class="span9">
      <h2>Welcome, {{ user.username }}!</h2>

      {# ------ Messages ------ #}
      {% for message in messages %}
      <div class="alert alert-success">
        <button class="close" data-dismiss="alert">x</button>
        {{ message }}
      </div> <!-- .alert .alert-success -->
      {% endfor %}
      <div class="alert alert-success">
        <button class="close" data-dismiss="alert">x</button>
        Success! <i class="icon-paper-clip"></i>
        Sample message for a success, you earned <span class="karma-points">+5 points</span>. Would you like to <a href="%">upload another</a>?
      </div> <!-- .alert .alert-success -->
      {# ------ End Messages ------ #}

      <!-- Carousel items -->
      <div id="myCarousel" class="carousel slide">
        <span class="counter">
          <span class="karma">2/5</span> profile completion tasks left
        </span>

        <p>You need <span class="karma">5 more karma points</span> to earn your first download. How about you:</p>

        <div class="carousel-inner">

          {% for message in messages %}
          <div class="{% if forloop.first %}active {% endif %}item">
            <div class="reminder">
              <a href="#">link to do thing</a>
              {{ message }}
              <span class="karma-points">+10 points</span>
            </div> <!-- .reminder -->
          </div> <!-- .active .item -->
          {% endfor %}

          <!-- more sample items -->
          <div class="item">
            <div class="reminder">
              <a href="#">Make a cake</a> and get some points.
              <span class="karma-points">+10 points</span>
            </div>
          </div> <!-- .item -->

          <div class="item">
            <div class="reminder">
              <a href="#">Eat a chicken</a> and get lots of protein. <span class="karma-points">+10 points</span>
            </div>
          </div> <!-- .item -->
          <!-- end sample items -->

        </div> <!-- carousel-inner -->
        <!-- Carousel nav -->
        <a class="carousel-control left" href="#myCarousel" data-slide="prev">&lsaquo;</a>
        <a class="carousel-control right" href="#myCarousel" data-slide="next">&rsaquo;</a>
      </div> <!-- #myCarousel .carousel .slide -->

      <!-- BEGIN COURSE LISTINGS -->
      <!-- one course -->
      <div class="course-listing">
        <h3>Your Courses</h3>
        {% for course in user.get_profile.courses.all %}
        <div class="course">
          <div class="folder icon">
            <img src="/static/img/icon-folder.png">
          </div>
          <div class="course-title">
            <a href="#">{{ course.title }}</a>
            <div class="course-info">
              <span class="instructor">{% if course.instructor %}{{ course.instructor }}{% else %}No instructor listed{% endif %}</span> <i class="icon-paper-clip"></i><a href="#">{{ course.files.count }} notes</a>
              {# TODO: not yet implemented downloaded files #}
              <!--
              <span class="your-files">Your: <a href="#">Uploads (1)</a> <a href="#">Downloads (2)</a></span> -->
            </div> <!-- .course-info -->
          </div> <!-- .course-title -->

          <div class="upload">
            <a class="button" data-toggle="modal" href="#upload">Upload notes</a>
          </div>
          <div style="clear:both"></div>
        </div> <!-- .course -->
        {% endfor %}
      </div> <!-- .course-listing -->

      <!-- begin file listing structure
      *** INACTIVE courses have "inactive" class in the wrapper
      and icon name is icon-folder-inactive.png
      {# replace this with an IF in for course in courses loop #}

      <div class="course inactive" data-toggle="collapse" data-target="#course-unique-1">
        <div class="folder icon">
          <img src="/static/img/icon-folder-inactive.png">
        </div>
        <div class="course-title">
          <a href="#">Shakespeare 101</a>
          <div class="course-info">
            <span class="instructor">Bill Spears</span> <i class="icon-paper-clip"></i><a href="#">21 notes</a>
            <span class="your-files">Your: <a href="#">Uploads (1)</a> <a href="#">Downloads (2)</a></span>
          </div>
        </div>
        <div class="upload">
          <a class="button" data-toggle="modal" href="#upload">Upload notes</a>
        </div>
        <div style="clear:both"></div>
      </div>
      end INACTIVE courses -->

      <div class="file-listing collapse in" id="course-unique-1">
        <!--
        {# makes a file for letter in your username #}
        {% for file in user.username %}
        <div class="file row-fluid">

          <div class="file icon"></div>

          <div class="file-title">
            <a href="#">Lecture 1-6 Notes</a>
          </div>

          <div class="file-description">
            This is a great file description, so much stuff, it will get cut off...
          </div>

          <div class="file-info-action hide row">
            <div class="file-info">
              <span class="user">Uploaded by <a href="#"><i class="icon-user"></i>USERNAME</a></span>
              <span class="download"><a href="#"><i class="icon-paper-clip"></i>View file</a></span>
              <span class="karma-points">-10 points</span>
              <span class="views">405 views</a>
            </div>
            <div class="file-actions">
              <a href="#"><i class="icon-heart"></i>Like (5)</a>
              <a href="#"><i class="icon-flag"></i>Flag</a>
              <a href="#"><i class="icon-pencil"></i>Edit</a>
              <a href="#"><i class="icon-remove-circle"></i>Delete</a>
            </div>
          </div> <!-- .file-info-action hide row -->
        </div> <!-- .file .row-fluid -->
        <!-- {% endfor %} -->

      </div> <!-- #course-unique-1 .file-listing .collapse .in -->

</div> <!-- .profile-page .container -->

{% endblock %}
